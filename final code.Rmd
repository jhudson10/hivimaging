---
title: "Final Code"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
setwd("~/Library/CloudStorage/OneDrive-King'sCollegeLondon/HIV project/Analysis_HIV_SR/hiv_mri_STATA")

#Load packages
library(tidyverse)
library(readr)
library(metafor)
library(meta)
library(readxl)
library(grid)
library(tidyr)
library(flextable)
library(boot)
library(epikit)
library(rmarkdown)
library(fmsb)
library(Cairo)
```

# CT Coronary Angiography
## Risk of 50% stenosis in PLHIV vs HIV negative comparators
```{r}
# Load data with odds ratios
#Load excel file
orf <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "all")

#Create database with only studies for CTCA with filter
orf <- orf %>%
  filter(scan== "ctca")%>%
  drop_na(stenhiv50n)%>%
  select(study, year, hivn_ct, stenhiv50n, 
         controln_ct, stencon50n, or_sten, pval_sten,
         ci.lb_sten, ci.ub_sten, adjust, qualityrating)%>%
  mutate(
    hneg = (hivn_ct - stenhiv50n),
    cneg = (controln_ct - stencon50n)) %>%
  rename(hpos = stenhiv50n, cpos = stencon50n, 
         hiv.n = hivn_ct, con.n = controln_ct, or = or_sten, 
         pval = pval_sten, ci.lb= ci.lb_sten, ci.ub = ci.ub_sten)%>%
  select(study, year, hpos, hneg, hiv.n, cpos, cneg, con.n, or, pval, ci.lb, ci.ub, qualityrating)
orf.1 <- orf %>% drop_na(cpos)

orf.1[c(5), c(3:8)] <- NA

#Absolute risk in HIV cmapred to HIV-
#absoltue risk in HIV_
risk.hiv.50 <- (sum(orf.1$hpos, na.rm = TRUE)/sum(orf.1$hiv.n, na.rm = TRUE))*100

#absolute risk  in controls
risk.con.50 <-(sum(orf.1$cpos, na.rm = TRUE)/sum(orf.1$con.n, na.rm = TRUE))*100
orf

#turn quality rating into factor with levels
orf[13] <- lapply(dat[13], factor, levels=c("poor", "fair", "good"))
orf

#total number of hivn
a <- sum(orf.1$hiv.n, na.rm = TRUE)
b <- sum(orf.1$con.n, na.rm = TRUE)
c <- sum(orf.1$hpos, na.rm = TRUE)
d <- sum(orf.1$cpos, na.rm = TRUE)
prevstenhiv <-(c/a)*100
prevstenhiv
prevstencon <- (d/b)*100
prevstencon

orf

# Remove Lai numbers only so that OR is usd.
orf[c(7), c(3:8)] <- NA



#Read in labels
labels <-read_csv("labs_50sten.csv") 
labels <- labels %>% arrange(year)





# Calcuate odds ratios using escalc 
es.50 <- escalc(measure= "RR", ai = hpos, bi = hneg, ci = cpos,
              di = cneg, 
              slab= orf$study,
              data = orf)

#Replace the missing values with the log odds ratios 

es.50$yi <- replmiss(es.50$yi, log(es.50$or))
# Convert the p-values into z values
es.50$zi <- sign(es.50$yi) * qnorm(es.50$pval/2, lower.tail=FALSE)
# Test statistics can be converted to standard errors
es.50$sei <- es.50$yi / es.50$zi
# CI bounds can be converted to SE
es.50$sei <- replmiss(es.50$sei, with(es.50, (log(ci.ub) - log(ci.lb))/(2*1.96)))
# Missing values with the vi variable can be replaced
es.50$vi <- replmiss(es.50$vi, es.50$sei^2)
# Delete variables
es.50$zi <- es.50$sei <- NULL



pes.50 <- rma(yi, vi, data = es.50)

#study labels
## Replace the first label with a greek letter, a superscript and a subscript
labs <-orf$study
labs[5] <- expression("Abd-Elmoniem 2014"^e)
labs[9] <- expression("Lai 2016"^f)

k <- nrow(orf)
# Forest plot of odds ratio
options(na.action = "na.pass")
forest(pes.50,
       addpred=TRUE, header=FALSE, order = orf$year,slab = labs,
       atransf=exp,
       addfit = FALSE,
       xlim = c(-30,5),
       textpos = c(-30, -3),
       ilab=cbind(labels$hiv, labels$control, labels$diff.ci),
       ilab.xpos=c(-20, -16, -10),
       ilab.pos = 2,
       xlab = "Prevalence Ratio (log scale)",
       digits = 2,
       at=log(c(0.1, .25, 1, 10, 50))) 
text(c(-21.5, -17.5, -12), 17.5, c("n/N (%)", "n/N (%)", "(95% CI)"))
text(-12,18.5, c(expression("Absolute Difference"^"c")))
text(c(-21.5, -17.5), 18.5, c(expression("HIV+"^"b"), "HIV -"), font =2)

text(-29, 18, expression("Study"^"a"), font = 2)
text(-5.25, 18, expression("Prevalence Ratio [95% CI]"^"d"), font = 2)
segments(-24, 18, -16, 18)
```


## 50% stenosis prevalence pooled (efigure 3)
```{r, warning=FALSE, echo = FALSE}
#Create database with only studies for CTCA with filter
#Load excel file
ct <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "all")

ct50 <- ct %>%
  filter(scan== "ctca") %>%
  drop_na(stenhiv50n)

# Remove lai et al. 
ct50 <- ct50[-c(9),]

#create labels
#remove et al. from data
ct50$study<-gsub("et al.","",as.character(ct50$study))
labs <- paste(ct50$study, ct50$year)

#set up data fram for proportion of PLHIV with Sensosis
ct50 <- ct50 %>% select(study, year, country, income, design, excludedcad, hivn_ct, stenhiv50n, controln_ct,stencon50n,  cd4, age_hiv, excludedcad, stableart, qualityrating)


sten.es <- escalc(xi = stenhiv50n, ni = hivn_ct, measure = "PLO", data = ct50, slab= study)
sten.pes <- rma(yi, vi, data = sten.es)

#write own transformation which is inverse of LOGIT * 100
mytransf <- function(x)
    (transf.ilogit(x)) * 100


forest(sten.pes, transf = mytransf,
       mlab= "",
       at = c(0,20,40,60,80,100),
       digits = 1, header= TRUE,
       ilab = cbind(ct50$stenhiv50n, ct50$hivn_ct),
       ilab.xpos = c(-85,-60),
       xlim = c(-150, 30),
       textpos = c(-150, 0),
       xlab = "Prevalence of >50% coronary stenosis (%)",
       order = ct50$year)


## add text with Q-value, dfs, p-value, and I^2 statistic
text(-150, -1, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(sten.pes$QE, digits=2, format="f")), ",p <0.005", "; ", I^2, " = ",
     .(formatC(sten.pes$I2, digits=1, format="f")), "%)")))
text(c(-85,-60), 17, c("n>50% Stenosis", "N"), font=2)


```


## 50% stenosis prevalence CVD included/excluded subgroup analysis (efigure 4)
```{r}
sten.pes.cvdexcluded <- rma(yi, vi, data = sten.es, subset=excludedcad=="yes", digits = 1)
sten.pes.cvdincluded <- rma(yi, vi, data = sten.es, subset=excludedcad=="no", digits = 1)


mlabfun <- function(text, sten.pes) {
   list(bquote(paste(.(text),
      " (Q = ", .(formatC(sten.pes$QE, digits=2, format="f")),
      ", p ", .(metafor:::.pval(sten.pes$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
      I^2, " = ", .(formatC(sten.pes$I2, digits=1, format="f")), "%, ",
      tau^2, " = ", .(formatC(sten.pes$tau2, digits=2, format="f")), ")")))}


mlabfun.include <- function(text, sten.pes.cvdincluded) {
   list(bquote(paste(.(text),
      " (Q = ", .(formatC(sten.pes.cvdincluded$QE, digits=1, format="f")),
      ", df = ", .(sten.pes.cvdincluded$k - sten.pes.cvdincluded$p),
      ", p ", .(metafor:::.pval(sten.pes.cvdincluded$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
      I^2, " = ", .(formatC(sten.pes.cvdincluded$I2, digits=1, format="f")), "%, ",
      tau^2, " = ", .(formatC(sten.pes.cvdincluded$tau2, digits=1, format="f")), ")")))}

mlabfun.exclude <- function(text, sten.pes.cvdexcluded) {
   list(bquote(paste(.(text),
      " (Q = ", .(formatC(sten.pes.cvdexcluded$QE, digits=1, format="f")),
      ", df = ", .(sten.pes.cvdexcluded$k - sten.pes.cvdexcluded$p),
      ", p ", .(metafor:::.pval(sten.pes.cvdexcluded$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
      I^2, " = ", .(formatC(sten.pes.cvdexcluded$I2, digits=1, format="f")), "%, ",
      tau^2, " = ", .(formatC(sten.pes.cvdexcluded$tau2, digits=1, format="f")), ")")))}

### set up forest plot (with 2x2 table counts added; the 'rows' argument is
### used to specify in which rows the outcomes will be plotted)


forest(sten.pes, transf=mytransf, refline = NA,
       ylim = c(-4, 27), digits = 1,
       xlim = c(-140, 110),
      
       rows=c(3:5, 11:22),
       ilab= cbind(sten.es$stenhiv50n, sten.es$hivn),
       ilab.xpos=c(-70,-50),
       order = sten.es$excludedcad,
       psize = 1, header="Study",
       mlab=mlabfun("RE Model for All Studies", sten.pes),
       xlab = "Prevalence of >50% coronary stenosis (%)")

op <- par(font=2)
text(c(-70, -50), 26, c("n >50% stenosis", "N"))

par(font=4)
#Add text for subgroups
text(-140, c(24,7), pos=4, c("Studies that excluded individuals with CVD",
                               "Studies that did not exclude individuals with CVD"))

addpoly(sten.pes.cvdexcluded, transf = mytransf, row=9, digits = 1,  mlab=mlabfun.exclude("RE Model for Subgroup", sten.pes.cvdexcluded))
addpoly(sten.pes.cvdincluded, transf = mytransf, row=1, digits = 1, mlab= mlabfun.include("RE Model for Subgroup", sten.pes.cvdincluded))

### fit meta-regression model to test for subgroup differences
res <- rma(yi, vi, mods = ~ excludedcad, data=sten.es)
 
### add text for the test of subgroup differences
text(-140, -3, pos=4, bquote(paste("Test for Subgroup Differences: ",
     Q[M], " = ", .(formatC(res$QM, digits=2, format="f")), ", df = ", .(res$p - 1),
     ", p = ", .(formatC(res$QMp, digits=2, format="f")))))

```


## eFigure 5. Sensitivity analysis for the prevalence of moderate to severe coronary stenosis on computed tomography coronary angiography in people living with HIV by restricting to studies with low / moderate risk of bias 
```{r}
# Removal of poor quality studies
ct50cvd <- ct50 %>%
  filter(qualityrating== "moderate" | qualityrating == "low")

sten.es.qual <- escalc(xi = stenhiv50n, ni = hivn_ct, measure = "PLO", data = ct50cvd, slab= study)
sten.pes.qual <- rma(yi, vi, data = sten.es.qual)

#write own transformation which is inverse of LOGIT * 100
mytransf <- function(x)
    (transf.ilogit(x)) * 100


forest(sten.pes.qual, transf = mytransf,
       mlab= "",
       at = c(0,20,40,60,80,100),
       digits = 1, header= TRUE,
       ilab = cbind(ct50cvd$stenhiv50n, ct50cvd$hivn_ct),
       ilab.xpos = c(-45,-25),
       xlim = c(-110, 150),
       xlab = "Prevalence of >50% coronary stenosis (%)",
       order = ct50cvd$year)


## add text with Q-value, dfs, p-value, and I^2 statistic
text(-110, -1, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(sten.pes.qual$QE, digits=2, format="f")), ",p = ", .(formatC(sten.pes.qual$QEp, digits=2, format="f")), "; ", I^2, " = ",
     .(formatC(sten.pes.qual$I2, digits=1, format="f")), "%)")))
text(c(-45,-25), 11.5, c("n", "N"), cex=0.75)

```

## Metaregressions for 50% coronary stenosis (efigure 6 )


```{r, warning=FALSE, echo=FALSE}
# Use metaprop to enable metaregressions. Repeat meta analysis of proportions using metaprop.


#Load excel file
ct1 <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "all")

#Create database with only studies for CTCA with filter
ct1 <- ct1 %>%
  filter(scan== "ctca") %>%
  drop_na(stenhiv50n)
# Remove lai et al. 
ct1 <- ct1[-c(7),]
#replaace hoffman denominator 755 to 743
ct1[6,7] <- 743
ct1 <- ct1 %>% select(study, year, country, income, design, excludedcad, hivn_ct, stenhiv50n, cd4, age_hiv, excludedcad, stableart, qualityrating, femalehivprop, bmihiv, smokehivprop, age_hiv, artprop, art_time, cd4, nadircd4)

ct1$cd4 <- as.numeric(ct1$cd4)
ct1$art_time <- as.numeric(ct1$art_time)
ct1$bmihiv <- as.numeric(ct1$bmihiv)


any <- metaprop(event = stenhiv50n, 
                   n = hivn_ct,
                   studlab = study,
                   data = ct1,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   pscale = 100,
                   digits = 1)

anyage <- metareg(any, ~ age_hiv, hakn = TRUE, method = "DL",
                       digits = 2,
                  subset= c(1:14)) #remove lo et al. from meta regression

# Mixed effects model meta regression
anyfemale <- metareg(any, ~ femalehivprop,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2)
# Meta regression of the proportion of smokers in the study population
# Not reported by: DETTORE
anysmoke <- metareg(any, ~ smokehivprop,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2) 
# Meta regression of BMI of study population against any coronary plaque

anybmi <- metareg(any, bmihiv,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2,
                  subset= c(1:14)) #remove lo et al. from meta regression)


anyart <- metareg(any, ~ artprop,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2)

anytime <- metareg(any, ~ art_time,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2,
                   subset= c(1:14)) #remove lo et al. from meta regression)


anycd4 <- metareg(any, ~ cd4,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2,
                        subset= c(1:14)) #remove lo et al. from meta regression)

# Meta regression of coronary plaque by mean nadir CD4 in study population
# Not reported by Hoffman, Jeudy

anynadir <- metareg(any, ~ nadircd4,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2,
                    subset= c(1:14)) #remove lo et al. from meta regression)



dev.new()
par(mfrow=c(4,2),oma=c(2,2,0,0))
regplot(anyage, 
        transf=mytransf, 
        main = "A",
        ylim = c(0,100),
        ylab = "",
        xlab = "Age (years)",
        ci= TRUE,
        label = FALSE,
        pi = FALSE)
regplot(anyfemale, 
        transf= mytransf, 
        main = "B",
        ylim = c(0,100),
        ylab = "",
        xlab = "Proportion of women in study population (%)",
        ci= TRUE,
        pi = FALSE)
regplot(anysmoke, 
        transf=mytransf, 
        main = "C",
        ylim = c(0,100),
        ylab = "",
        xlab = "Proportion of smokers in study population (%)",
        ci= TRUE,
        pi = FALSE)
regplot(anybmi, 
        transf= mytransf, 
        main = "D",
        ylim = c(0,100),
        ylab = "",
        xlab = "Mean BMI in study population (kg/m2)",
        ci= TRUE,
        pi = FALSE)
regplot(anyart, 
        transf= mytransf,
        main = "E",
        ylim = c(0,100),
        ylab = "",
        xlab = "Proportion of HIV+ on ART",
        ci= TRUE,
        pi = FALSE)
regplot(anytime, 
        transf=mytransf, 
        main = "F",
        ylim = c(0,100),
        ylab = "",
        xlab = "Mean duration on ART (years)",
        ci= TRUE,
        pi = FALSE)
regplot(anycd4, 
        transf= mytransf,
        main = "G",
        ylim = c(0,100),
        ylab = "",
        xlab = "Mean CD4 count (cells/microl)",
        ci= TRUE,
        pi = FALSE)
regplot(anynadir, 
        transf=mytransf, 
        main = "H",
        ylim = c(0,100),
        ylab = "",
        xlab = "Nadir CD4 count (cells/microl)",
        ci= TRUE,
        pi = FALSE)
mtext("Prevalence of >50% coronary stenosis (%)",side=2,line=0,outer=TRUE,las=0)
```

### Summary of Meta Regressions of any 50% stenosis

```{r, echo=FALSE, warning=FALSE}
regresult <- tibble(
    Variable = c("Age", "Proportion female", "Proportion smokers", "Mean BMI", "Proportion on ART", "Time on ART", "Mean CD4", "Nadir CD4"),
    no.studies = c(anyage$k, anyfemale$k, anysmoke$k, anybmi$k, anyart$k, anytime$k, anycd4$k, anynadir$k),
    regression.coefficent = c(anyage$b[[2]], anyfemale$b[[2]], anysmoke$b[[2]], anybmi$b[[2]], anyart$b[[2]], anytime$b[[2]], anycd4$b[[2]], anynadir$b[[2]]),
    ci.lower = c(anyage$ci.lb[[2]], anyfemale$ci.lb[[2]], anysmoke$ci.lb[[2]], anybmi$ci.lb[[2]], anyart$ci.lb[[2]], anytime$ci.lb[[2]], anycd4$ci.lb[[2]], anynadir$ci.lb[[2]]),
    ci.upper = c(anyage$ci.ub[[2]], anyfemale$ci.ub[[2]], anysmoke$ci.ub[[2]], anybmi$ci.ub[[2]], anyart$ci.ub[[2]], anytime$ci.ub[[2]], anycd4$ci.ub[[2]], anynadir$ci.ub[[2]]),
    p.value = c(anyage$pval[[2]], anyfemale$pval[[2]], anysmoke$pval[[2]], anybmi$pval[[2]], anyart$pval[[2]], anytime$pval[[2]], anycd4$pval[[2]], anynadir$pval[[2]]),
    R2 = c(anyage$R2, anyfemale$R2, anysmoke$R2, anybmi$R2, anyart$R2, anytime$R2, anycd4$R2, anynadir$R2),
      )%>%
  mutate(across(where(is.numeric), round, digits = 2))
regresult <- regresult %>% flextable() %>%
  theme_vanilla()%>%
  set_header_labels(
    variable = "Variable",
    no.studies = "N studies",
    regression.coefficent = "Regression Coefficent",
    ci.lower = "95% CI lower",
    ci.upper = "95% CI upper",
    p.value = "P Value",
    R2 = "R Squared")
print(regresult, preview= "docx")

```


## risk of moderate to severe coronary artery stenosis detected by CT coronary angiography in people living with HIV and uninfected comparator (efigure 7)
```{r}

k <- nrow(orf)
# Forest plot of odds ratio
options(na.action = "na.omit")
forest(pes.50,
       addpred=TRUE, header=FALSE, order = orf$year,
       slab = labs1,
       atransf=exp,
       addfit = TRUE,
       mlab = "",
       xlim = c(-30,5),
       textpos = c(-30, -3),
       ilab=cbind(labels$hiv, labels$control, labels$diff.ci),
       ilab.xpos=c(-20, -16, -10),
       ilab.pos = 2,
       xlab= "Prevalence ratio (log scale)",
       digits = 2,
       at=log(c(0.1, .25, 1, 10, 50))) 
text(c(-21.5, -17.5, -12), 12.5, c("n/N (%)", "n/N (%)", "(95% CI)"))
text(-12,13.25, c("Absolute Difference"))
text(c(-21.5, -17.5), 13.5, c(expression("HIV+"), "HIV -"), font =1)
text(-30, 12.5, "Study", pos = 4)
text(-3, 12.5, "Prevalence ratio [95% CI]", font = 1, pos = 2)

segments(-24, 13, -16, 13)

## add text with Q-value, dfs, p-value, and I^2 statistic
text(-30, k-17, pos=4, bquote(paste("RE Model (Q = ",
                                              .(formatC(pes.50$QE, digits=2, format="f")), ", df = ", .(pes.50$k - pes.50$p),
                                              ", p = 0.05 ",  "; ", I^2, " = ",
                                              .(formatC(pes.50$I2, digits=2, format="f")), "%)")))
```


## Coronary plaque analysis

## Prevalence of coronary plaque
```{r}

#Begin Cleaning pipe chain
##########################

#Load excel file
ct <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "all")

#Create database with only studies for CTCA with filter
ct <- ct %>%
  filter(scan== "ctca") %>%
  drop_na(anyplaque_n_hiv)
ct
#Drop Lai and duarte
ct <- ct[-c(2,7),]




#set up data frame
ct <- ct %>% select(study, year, country, income, design, excludedcad, hivn_ct, anyplaque_n_hiv, cd4, age_hiv, excludedcad, stableart, qualityrating)



any.es <- escalc(xi = anyplaque_n_hiv, ni = hivn_ct, measure = "PLO", data = ct, slab= ct$study)
any.pes <- rma(yi, vi, data = any.es)

#write own transformation which is inverse of LOGIT * 100
mytransf <- function(x)
    (transf.ilogit(x)) * 100


forest(any.pes, transf = mytransf,
       mlab= "",
       digits = 1, header= TRUE,
       ilab = cbind(ct$anyplaque_n_hiv, ct$hivn_ct),
       ilab.xpos = c(-45,-25),
       xlim = c(-110, 150),
       xlab = "Prevalence of Coronary Plaque (%)",
       order = ct$year)

text(c(-45,-25), 14, c("Cases", "N"))

## add text with Q-value, dfs, p-value, and I^2 statistic
text(-110, -1, pos=4, bquote(paste("RE Model (Q = ",
     .(formatC(any.pes$QE, digits=2, format="f")), ",p <0.05 ","; ", I^2, " = ",
     .(formatC(any.pes$I2, digits=1, format="f")), "%)")))



```

##  Risk of coronary plaque

```{r}
#new analysis using the correct database

# Load data with odds ratios
#Load excel file
or.any <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "all")

#Create database with only studies for CTCA with filter
or.any <- or.any %>%
  filter(scan== "ctca") %>%
  drop_na(anyplaque_n_hiv)

#set up data frame for proportion of PLHIV with plaque
or.any <- or.any %>% select(study, year, hivn_ct, anyplaque_n_hiv, controln_ct, anyplaque_n_con, or_any, pval_any, ci.lb_any, ci.ub_any, adjust)

or.any <- or.any %>%
  mutate(
    hneg = (hivn_ct - anyplaque_n_hiv),
    cneg = (controln_ct - anyplaque_n_con)
  ) %>%
  rename(hpos = anyplaque_n_hiv, cpos = anyplaque_n_con, 
         hiv.n = hivn_ct, con.n = controln_ct, or = or_any, 
         pval = pval_any, ci.lb= ci.lb_any, ci.ub = ci.ub_any) %>%
  select(study, year, hiv.n, hpos, hneg, con.n, cpos, cneg, or, pval,
         ci.lb, ci.ub, adjust)

rlabs <- or.any

#create databse for labels fr plt
rlabs <- rlabs %>%
  mutate(
    hivprop = (hpos/hiv.n)*100,
    conprop = (cpos/con.n)*100,
    diff = hivprop - conprop,
  ) %>%
  select(study, year, hiv.n, hpos, hivprop, cpos, con.n, conprop, diff)
rlabs
write_csv(rlabs, file= "rlabs.csv")

#calculate risk difference
#Abdelmoneim
riskdifference(6, 5, 35, 11)
#Boldeaunu
riskdifference(109, 47, 155, 84)
#fitch
riskdifference(84, 27, 155, 70)
#post
riskdifference(350, 230, 450, 309)
#senoner
riskdifference(56, 46, 67, 67)
#Tarr
riskdifference(226, 164, 428, 276)
#Dabramao
riskdifference(18, 0, 35, 21)
#jeudy
riskdifference(31, 15, 79, 22)
#pereyra
riskdifference(7, 21, 9, 49)
#li
riskdifference(110, 100, 167, 185)



# read in labels file
plab <- read.csv(file = "plaque_plot_labs.csv")
plab <- plab %>% arrange(year)

#Remove Lai 1
or.any[c(6), c(3:7)] <- NA

#create branch off df for labels
or.anylabs <- or.any

#remove values from df for escalc
or.any[c(2, 6,7, 9), c(3:8)] <- NA


# Calcuate odds ratios using escalc 
es <- escalc(measure= "RR", ai = hpos, bi = hneg, ci = cpos,
              di = cneg, 
              slab= or.any$study,
              data = or.any)

#Replace the missing values with the log odds ratios 
es$yi <- replmiss(es$yi, log(es$or))
# Convert the p-values into z values
es$zi <- sign(es$yi) * qnorm(es$pval/2, lower.tail=FALSE)
# Test statistics can be converted to standard errors
es$sei <- es$yi / es$zi
# CI bounds can be converted to SE
es$sei <- replmiss(es$sei, with(es, (log(ci.ub) - log(ci.lb))/(2*1.96)))
# Missing values with the vi variable can be replaced
es$vi <- replmiss(es$vi, es$sei^2)
# Delete variables
es$zi <- es$sei <- NULL



pes <- rma(yi, vi, data = es)

labs <-plab$study
labs[7] <- expression("Lai 2016"^a)

# Forest plot of odds ratio
options(na.action = "na.omit")
forest(pes,
       addpred=TRUE, header=FALSE,
       slab = labs,
       atransf=exp,
       xlim = c(-30,0),
       textpos = c(-30, -3),
       order = or.any$year,
      ilab=cbind(plab$hiv, plab$con, 
                 plab$ad),
      ilab.pos = 2,
       ilab.xpos=c(-20, -16, -10),
      mlab = "Random effects model",
      xlab = c("Prevalence Ratio (log scale)"),
        at=log(c(0.1, .25, 1, 10, 30)))

#Add text to label columns
text(c(-21.5, -17.5, -12), 9.25, c(expression("n/N (%) plaque"), "n/N (%) plaque", "[95% CI]"))
text(-12,10, c(expression("Absolute Difference"^"b")))
text(c(-21.5, -17.5), 10, c("HIV+", "HIV-"), font =1)
text(-29, 9.25, c("Study"), font = 1)
text(-5.5, 9.25, c("Prevalence Ratio [95% CI]"), font = 1)

## add text with Q-value, dfs, p-value, and I^2 statistic
text(-30, -1.5, pos=4, cex=0.75, bquote(paste("Q = ",
     .(formatC(pes$QE, digits=2, format="f")), ", df = ", .(pes$k - pes$p),
     ", p <0.05 ", "; ", I^2, " = ",
     .(formatC(pes$I2, digits=1, format="f")), "%")))

```

## Risk of coronary plaque with high risk of bias studies excluded
```{r}
pes.qual <- rma(yi, vi, data = es, subset = (qualityrating =="moderate"|qualityrating=="low"))
labs[7] <- expression("Lai 2016")
options(na.action = "na.omit")
forest(pes.qual,
       addpred=TRUE, header=FALSE,
       slab = labs,
       atransf=exp,
       xlim = c(-30,0),
       textpos = c(-30, -3),
      ilab=cbind(plab$hiv, plab$con, 
                 plab$ad),
      ilab.pos = 2,
       ilab.xpos=c(-20, -16, -10),
      mlab = "Random effects model",
      xlab = c("Prevalence Ratio (log scale)"),
        at=log(c(0.1, .25, 1, 10, 30)))

#Add text to label columns
text(c(-21.5, -17.5, -12), 6.5, c(expression("n/N (%) plaque"), "n/N (%) plaque", "[95% CI]"))
text(-12,7.5, c(expression("Absolute Difference"^"b")))
text(c(-21.5, -17.5), 7.5, c("HIV+", "HIV-"), font =1)
text(-30, 6.5, c("Study"), font = 1, pos = 4)
text(-1, 6.5, c("Prevalence Ratio [95% CI]"), pos = 2, font = 1)

## add text with Q-value, dfs, p-value, and I^2 statistic
text(-30, -1.5, pos=4, cex=0.75, bquote(paste("Q = ",
     .(formatC(pes.qual$QE, digits=2, format="f")), ", df = ", .(pes.qual$k - pes.qual$p),
     ", p <0.05 ", "; ", I^2, " = ",
     .(formatC(pes.qual$I2, digits=1, format="f")), "%")))

```


## Prevalence of LGE in PLHIV
```{r}
#Begin Cleaning pipe chain
##########################

#Load excel file
mri2 <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "all")
mri2 <- mri2 %>% filter(scan == "cmr")

#Create subset of data that contains LGE in HIV only
  mri2 <- mri2%>% drop_na(lgehivn)


#set up data fram for proportion of PLHIV with LGE
mri2 <- mri2 %>% select(study, year, country, income, design, excludedcad, hivnmri, lgehivn, cd4, age_hiv, excludedcad, stableart, qualityrating, nadircd4, smokehivprop)

mri2 <- mri2 %>% rename(agehiv = age_hiv)

lge.es <- escalc(xi = lgehivn, ni = hivnmri, measure = "PLO", data = mri2, slab= mri2$study)
lge.pes <- rma(yi, vi, data = lge.es)
lge.pes.cd4 <- rma(yi, vi, data = lge.es, mods = ~ cd4)

#write own transformation which is inverse of LOGIT * 100
mytransf <- function(x)
    (transf.ilogit(x)) * 100


forest(lge.pes, transf = mytransf,
       mlab= "",
       digits = 1, header= TRUE,
       xlim = c(-100, 140),
       ilab = cbind(mri2$lgehivn, mri2$hivnmri),
       ilab.xpos = c(-45,-25),
       xlab = "Prevalence of LGE (%)",
       order = mri2$year,
       col= "blue"
      )

## add text with Q-value, dfs, p-value, and I^2 statistic
text(-100, -1, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(lge.pes$QE, digits=1, format="f")), ",p = ", .(formatC(lge.pes$QEp, digits=3, format="f")), "; ", I^2, " = ",
     .(formatC(lge.pes$I2, digits=1, format="f")), "%)")))
text(c(-45,-25), 17, c("LGE+", "N"), cex=0.75)

```

### Subgroup income status
```{r}
dev.new()
forest(lge.pes, transf=mytransf, refline = NA, order = lge.es$income,
       ylim = c(-4, 27), digits = 1, header = "Study & year",
       rows = c(4:14, 19:22),
        ilab= cbind(lge.es$lgehivn, lge.es$hivn),
       ilab.xpos=c(-50,-20),
       xlab = "Prevalence of LGE (%)",
       cex = 0.75,
       mlab = mlabfun("RE model for all studies", lge.pes),
       xlim = c(-140, 145))

### set font expansion factor (as in forest() above) and use a bold font
op <- par(cex=0.75, font=2)

text(c(-50, -20), 26, c("LGE+", "N"), cex = 0.75)

par(font = 4)

text(-140, c(23.5,15.5), pos=4, c("Studies performed in UMIC",
                               "Studies performed in HIC"))

lge.pes.umic <- rma(yi, vi, data = lge.es, subset=income=="umic")
lge.pes.hic <- rma(yi, vi, data = lge.es, subset=income=="hic")

par(op)

### add summary polygons for the three subgroups
addpoly(lge.pes.umic, row=17, digits = 1, transf = mytransf, mlab=mlabfun("RE Model for Subgroup", lge.pes.umic))
addpoly(lge.pes.hic, row= 2, digits = 1, transf = mytransf, mlab=mlabfun("RE Model for Subgroup", lge.pes.hic))


### fit meta-regression model to test for subgroup differences
res.income <- rma(yi, vi, mods = ~ income, data=lge.es)
 
### add text for the test of subgroup differences
text(-140, -3, pos=4, cex=0.75, bquote(paste("Test for Subgroup Differences: ",
     Q[M], " = ", .(formatC(res.income$QM, digits=2, format="f")), ", df = ", .(res$p - 1),
     ", p = ", .(formatC(res.income$QMp, digits=2, format="f")))))
```


### Subgroup analysis by CVD
```{r}
lge.pes.cvdexcluded <- rma(yi, vi, data = lge.es, subset=excludedcad=="yes", digits = 1)
lge.pes.cvdincluded <- rma(yi, vi, data = lge.es, subset=excludedcad=="no", digits = 1)


mlabfun <- function(text, lge.pes) {
   list(bquote(paste(.(text),
      " (Q = ", .(formatC(lge.pes$QE, digits=2, format="f")),
      ", p ", .(metafor:::.pval(lge.pes$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
      I^2, " = ", .(formatC(lge.pes$I2, digits=1, format="f")), "%, ",
      tau^2, " = ", .(formatC(lge.pes$tau2, digits=2, format="f")), ")")))}


mlabfun.include <- function(text, lge.pes.cvdincluded) {
   list(bquote(paste(.(text),
      " (Q = ", .(formatC(lge.pes.cvdincluded$QE, digits=1, format="f")),
      ", df = ", .(lge.pes.cvdincluded$k - lge.pes.cvdincluded$p),
      ", p ", .(metafor:::.pval(lge.pes.cvdincluded$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
      I^2, " = ", .(formatC(lge.pes.cvdincluded$I2, digits=1, format="f")), "%, ",
      tau^2, " = ", .(formatC(lge.pes.cvdincluded$tau2, digits=1, format="f")), ")")))}

mlabfun.exclude <- function(text, lge.pes.cvdexcluded) {
   list(bquote(paste(.(text),
      " (Q = ", .(formatC(lge.pes.cvdexcluded$QE, digits=1, format="f")),
      ", df = ", .(lge.pes.cvdexcluded$k - lge.pes.cvdexcluded$p),
      ", p ", .(metafor:::.pval(lge.pes.cvdexcluded$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
      I^2, " = ", .(formatC(lge.pes.cvdexcluded$I2, digits=1, format="f")), "%, ",
      tau^2, " = ", .(formatC(lge.pes.cvdexcluded$tau2, digits=1, format="f")), ")")))}

### set up forest plot (with 2x2 table counts added; the 'rows' argument is
### used to specify in which rows the outcomes will be plotted)

dev.new(
)
forest(lge.pes, transf=mytransf, refline = NA,
       ylim = c(-4, 27), digits = 1,
       xlim = c(-140, 145),
       rows=c(3:7, 13:22),
       ilab= cbind(lge.es$lgehivn, lge.es$hivn),
       ilab.xpos=c(-80,-70),
       order = lge.es$excludedcad,
       psize = 1, cex = 0.75, header="Study",
       cex.lab  = 0.75,
       mlab=mlabfun("RE Model for All Studies", lge.pes),
       xlab = "Prevalence of LGE (%)")

op <- par(cex=0.75, font=2)
text(c(-80, -70), 26, c("LGE", "N"), cex = 0.75)

par(font=4)
#Add text for subgroups
text(-140, c(24,9), pos=4, c("Studies that excluded individuals with CVD",
                               "Studies that did not exclude individuals with CVD"))

par(op)
addpoly(lge.pes.cvdexcluded, transf = mytransf, row=11.5, digits = 1,  mlab=mlabfun.exclude("RE Model for Subgroup", lge.pes.cvdexcluded))
addpoly(lge.pes.cvdincluded, transf = mytransf, row=1.5, digits = 1, mlab= mlabfun.include("RE Model for Subgroup", lge.pes.cvdincluded))

### fit meta-regression model to test for subgroup differences
res <- rma(yi, vi, mods = ~ excludedcad, data=lge.es)
 
### add text for the test of subgroup differences
text(-140, -3, pos=4, cex=0.75, bquote(paste("Test for Subgroup Differences: ",
     Q[M], " = ", .(formatC(res$QM, digits=2, format="f")), ", df = ", .(res$p - 1),
     ", p = ", .(formatC(res$QMp, digits=2, format="f")))))

```

### Sensitivity analysis- removal of low quality studies
```{r}
#Updated meta estiamte with Frustaci removed and Breukman
#Create dataframe with Frustaci and Breukman removed
mriquality <- mri2 %>% 
  filter(qualityrating != "high")   


lge.hi <- escalc(xi = lgehivn, ni = hivnmri, measure = "PLO", data = mriquality, slab= mriquality$study)
hi.pes <- rma(yi, vi, data = lge.hi)

#write own transformation which is inverse of LOGIT * 100
mytransf <- function(x)
    (transf.ilogit(x)) * 100

forest(hi.pes, transf = mytransf,
       mlab= "",
       digits = 1, header= TRUE,
       xlim = c(-100, 140),
       ilab = cbind(mriquality$lgehivn, mriquality$hivnmri),
       ilab.xpos = c(-45,-25),
       xlab = "Prevalence of LGE (%)",
       order = mriquality$year,
       col= "blue"
      )

## add text with Q-value, dfs, p-value, and I^2 statistic
text(-100, -1, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
     .(formatC(hi.pes$QE, digits=1, format="f")), ",p <0.05 ",  "; ", I^2, " = ",
     .(formatC(hi.pes$I2, digits=1, format="f")), "%)")))
text(c(-45,-25), 11, c("LGE+", "N"))
```


## Meta regressions for LGE prevalence

```{r}
dev.new()
layout(matrix(c(1,1,2,3), 2, 2, byrow = TRUE))
# meta analysis of proportions using metaprop
lge <-  metaprop(event = mri2$lgehivn, 
                   n = mri2$hivnmri,
                   studlab = study,
                   data = mri2,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   title = "LGE prevalence",
                   pscale = 100,
                   digits = 1)

### Mean CD4 count

#For mean CD4, Ntusi et al. do not present a CD4 count, the same cohort is included in Holloway et al.
#Therefore the meta analysis of prevalence will be repeated with Holloway instead of Ntusi

#Meta analysis of prevalence of LGE (Hollloway replacing NTUSI)

mricd4 <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "mricd4") #read in new excel with holloway

#Create subset of data that contains LGE in HIV only
mricd4 <- mricd4 %>% drop_na(lgehivn)

#Perform meta analysis of proportions
cd4 <- metaprop(event = mricd4$lgehivn, 
                   n = mricd4$hivnmri,
                   studlab = paper,
                   data = mricd4,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   title = "LGE prevalence",
                   pscale = 100,
                   digits = 1)


# Mixed effects model meta regression
lgecd4.2 <- metareg(cd4, ~ cd4mean,
                       hakn = TRUE,
                       method = "DL",
                       pscale = 100,
                       digits = 2,
                    studlab = TRUE)

#plot

regplot(lgecd4.2, 
        transf=mytransf, 
        ylim = c(0,100),
        ylab = "Prevalence of LGE (%)",
        xlab = "Mean CD4 count (cells/microL)",
        ci= TRUE,
        pi = FALSE,
        label = FALSE)
mtext(c("A"), side = 3, line = 1)

# Mixed effects model meta regression
lgeage <- metareg(lge, ~ agehiv,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2)

regplot(lgeage, 
        transf=mytransf, 
        ylim = c(0,100),
        ylab = "Prevalence of LGE (%)",
        xlab = "Age (years)",
        ci= TRUE,
        pi = FALSE)

mtext(c("B"), side = 3, line = 1)

#Smokers

# Mixed effects model meta regression
lgesmoke <- metareg(lge, ~ smokehivprop,
                       hakn = TRUE,
                       digits = 2)


regplot(lgesmoke, 
        transf=mytransf, 
        ylim = c(0,100),
        ylab = "Prevalence of LGE (%)",
        xlab = "Proportion of smokers in study population(%)",
        ci= TRUE,
        label = FALSE,
        pi = FALSE)
mtext(c("C"), side = 3, line = 1)
```

### Summary of Meta-Regressions

```{r, echo=FALSE}
mrireg <- tibble(
    variable = c("Age", "CD4 Count", "Proportion of Smokers"),
    no.studies = c(lgeage$k, lgecd4.2$k, lgesmoke$k),
    regression.coefficent = c(lgeage$b[[2]], lgecd4.2$b[[2]], lgesmoke$b[[2]]),
    ci.lower = c(lgeage$ci.lb[[2]], lgecd4.2$ci.lb[[2]], lgesmoke$ci.lb[[2]]),
    ci.upper = c(lgeage$ci.ub[[2]], lgecd4.2$ci.ub[[2]], lgesmoke$ci.ub[[2]]),
    p.value = c(lgeage$pval[[2]], lgecd4.2$pval[[2]], lgesmoke$pval[[2]]),
    R2 = c(lgeage$R2, lgecd4.2$R2, lgesmoke$R2)) %>%
  mutate(across(where(is.numeric), round, digits = 3))
mrireg <- flextable(mrireg) %>%
  theme_vanilla()%>%
  set_header_labels(
    variable = "Variable",
    no.studies = "N studies",
    regression.coefficent = "Regression Coefficent",
    ci.lower = "95% CI lower",
    ci.upper = "95% CI upper",
    p.value = "P Value",
    R2 = "R Squared")%>%
  autofit()
mrireg
```


# Funnell Plots MRI
```{r}
dev.new()

par(mfrow=c(3,1),oma=c(2,2,0,0))

funnel(lge.pes, atransf = mytransf, xlab = "Prevalence of LGE (%)", digits = 1)
mtext("A", side =3, line = 1)

regtest(lge.pes, model="lm", predictor="sei", digits = 1)

funnel(any.pes, atransf = mytransf, xlab = "Prevalence of coronary plaque (%)", digits = 1)
mtext("B", side =3, line = 1)
regtest(any.pes, model="lm", predictor="sei", digits = 1)

funnel(sten.pes, atransf =  mytransf,  xlab = "Prevalence of >50% coronary stenosis (%)")
mtext("C", side =3, line = 1)
regtest(sten.pes, model="lm", predictor="sei", digits = 1)

```


# Figure 3
```{r}
# Load data with odds ratios
ormri <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "all")

#Create labels with all studies for plot
#Load excel file
m1 <- read_xlsx("o1.xlsx")
m1 <- m1 %>% select(study, year, hiv, con, diffci)
m1 <- arrange(m1,year)

ormri <- ormri %>% filter(scan == "cmr")

ormri <- ormri %>% select(study, year,hivnmri, lgehivn, nolgehivn, controlnmri, lgecontroln, 
                          nolgecontroln, or.lge, pval.lge, ci.lb.lge, ci.ub.lge, adjust, qualityrating)


ormri <- ormri %>%
  rename(hpos = lgehivn, hneg = nolgehivn, cpos = lgecontroln, 
         cneg = nolgecontroln, hiv.n = hivnmri, con.n = controlnmri, or = or.lge, 
         pval = pval.lge, ci.lb= ci.lb.lge, ci.ub = ci.ub.lge)


#calculate the number of N across which prevalence is calculated
ormin <- ormri %>%
  drop_na(cpos)
#sum of total N hiv used for odds ratio
hivN <- sum(ormin$hiv.n)
hivLGE <- sum(ormin$hpos)
conN <- sum(ormin$con.n)
conLGE <- sum(ormin$cpos)
hivN
conN



#Prevalence of LGE in those with comparator group
hivlge <- (hivLGE/hivN)*100
conlge <- (conLGE/conN)*100
hivlge
conlge
ormri

#drop pineuria
ormri <- ormri[-c(12),]

# Remove Wu and Shuldiner data for label
#Create a second DF to allow for labels to be added to the forest plot
ormri1 <- ormri

ormri

# Calcuate odds ratios using escalc 
es.orlge <- escalc(measure= "RR", ai = hpos, bi = hneg, ci = cpos,
              di = cneg, 
              slab= ormri$study,
              data = ormri)
labs <- ormri$study
## Replace the first label with a greek letter, a superscript and a subscript



#Replace the missing values with the log odds ratios in Wu et al and Shuldiner
es.orlge$yi <- replmiss(es.orlge$yi, log(es.orlge$or))
# Convert the p-values into z values
es.orlge$zi <- sign(es.orlge$yi) * qnorm(es.orlge$pval/2, lower.tail=FALSE)
# Test statistics can be converted to standard errors
es.orlge$sei <- es.orlge$yi / es.orlge$zi
# CI bounds can be converted to SE
es.orlge$sei <- replmiss(es.orlge$sei, with(es.orlge, (log(ci.ub) - log(ci.lb))/(2*1.96)))
# Missing values with the vi variable can be replaced
es.orlge$vi <- replmiss(es.orlge$vi, es.orlge$sei^2)
# Delete variables
es.orlge$zi <- es.orlge$sei <- NULL


#Random effects model
res.or <- rma(yi, vi, data = es.orlge)
predict(res.or, transf=exp, digits=2)

o <- ormri1 %>%
  select(study, year, hpos, hiv.n, cpos, con.n)%>%
  mutate(
    hivprop = (hpos/hiv.n)*100,
    conprop = (cpos/con.n)*100,
    diff = (hivprop - conprop)
  )%>%
  mutate(across(2:6, round, 0))%>%
  mutate(across(7:9, round, 1))

#study labels
## Replace the first label with a greek letter, a superscript and a subscript
labs <-ormri$study
labs[9] <- expression("Zanni 2020"^e)
labs[10] <- expression("Menacho 2020"^e)

o <- o %>% drop_na(cpos)
totals <- c("357/751 (47.5%)", "153/482 (31.7%)")




# Forest plot of odds ratio
options(na.action = "na.pass")
sav <- forest(res.or,
       addpred=TRUE, header=FALSE,
       addfit = FALSE,
       atransf=exp,
       order = ormri$year,
       slab = labs,
       xlim = c(-30,5),
       textpos = c(-30, -3),
       ilab=cbind(m1$hiv, m1$con, m1$diffci),
       ilab.xpos=c(-20, -16, -10),
       ilab.pos = 2,
       xlab = "Prevalence Ratio (log scale)",
       digits = 2,
       at=log(c(0.1, .25, 1, 10, 100))) 
text(c(-21.5, -17.5, -12), 16.5, c("LGE+/N (%)", "LGE+/N (%)", "[95% CI]"))
text(-12,17.5, c(expression("Absolute Difference"^"c")))
text(c(-21.5, -17.5), 17.5, c(expression("HIV+"^"b"), "HIV -"), font =2)

text(-29, 16.5, expression("Study"^"a"),font = 2)
text(-5.25, 17, expression("Prevalence Ratio [95% CI]"^"d"), font = 2)

segments(-24, 17, -16, 17)

```

# efigure LGE risk
```{r}
options(na.action = "na.omit")
forest(res.or,
       addpred=TRUE, header=FALSE,
       addfit = TRUE,
       atransf=exp,
       order = ormri$year,
       slab = labs,
       xlim = c(-30,5),
       textpos = c(-30, -3),
       ilab=cbind(m1$hiv, m1$con, m1$diffci),
       ilab.xpos=c(-20, -16, -10),
       ilab.pos = 2,
       mlab = "",
       xlab = "Prevalence ratio (log scale)",
       digits = 2,
       at=log(c(0.1, .25, 1, 10, 100))) 
text(c(-21.5, -17.5, -12), 10.5, c("LGE+/N (%)", "LGE+/N (%)", "[95% CI]"))
text(-12,11, c(expression("Absolute Difference")))
text(c(-21.5, -17.5), 11.25, c(expression("HIV+"), "HIV -"), font =2)
segments(-24, 17, -16, 17)
text(-29, 10.5, "Study",font = 2)
text(-3, 10.5, "Prevalence ratio [95% CI]",font = 2, pos = 2)

## add text with Q-value, dfs, p-value, and I^2 statistic
text(-17, -1,pos = 2, bquote(paste("RE Model (Q = ",
                                              .(formatC(res.or$QE, digits=2, format="f")), ", df = ", .(res.or$k - res.or$p),
                                              ", p <0.005 ", "; ", I^2, " = ",
                                              .(formatC(res.or$I2, digits=1, format="f")), "%)")))

```


# PET META ANALYSIS

```{r}
#Load excel file
pet <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "all")
pet <- pet %>% filter(scan == "pet") %>%
  select(study, atbr, m1i, sd1i, m2i, sd2i, pval, diff, matched_v, stat_adjust, hivn, controln, ci.low, ci.up, qualityrating, excludedcad)%>%
  drop_na(atbr)
pet$controln <- as.numeric(pet$controln)

#replace values for TAWAKOL
pet[4, 11] <- 15
pet[4,12] <- 15

#Calculat standard error and standard deviation.
pet <- pet %>% mutate(
  z.diff = -.862 +sqrt(0.743 - (2.40*log(pval))),
  se.diff = (diff/z.diff),
  sd.diff = se.diff*sqrt(hivn+controln))
pet
k <- nrow(pet)

labs <-pet$study
labs[3] <- expression("Knudsen 2015*")
labs[5] <- expression("Longenecker 2018*"^d)
labs[7] <- expression("Taglieri 2018*")
labs[4] <- expression("Tawakol 2017"^c)


pet.pes <- rma(yi= diff, sei = se.diff, data = pet, slab = study)
forest(pet.pes,
       addpred=TRUE, header=FALSE,
       xlim= c(-5,0),
       addfit = TRUE,
       slab = labs,
       textpos = c(-5, -.5),
       ilab=cbind(pet$hivn, pet$m1i, pet$controln, pet$m2i),
       ilab.xpos=c(-3.75, -3.25, -2.5, -2),
       mlab = "",
       digits = 2,
       col = "blue",
       xlab = c("Mean difference in TBR"),)

text(c(-3.75, -3.25, -2.5, -2), 8.5, c("N", expression("Aortic TBR"^"a"), "N", "Aortic TBR"))
text(-5, 8.5, "Study", font = 2, pos =4)
text(-1,8.5, c(expression("TBR Difference"^"b")))
text(c(-3.5, -2.25), 9.6, c(expression("HIV+"), "HIV -"), font =2)

### add horizontal line at the top
segments(-4, 9.2, -1.6, 9.2)





## add text with Q-value, dfs, p-value, and I^2 statistic
text(-5, -1, pos=4, bquote(paste("RE Model (Q = ",
                                              .(formatC(pet.pes$QE, digits=2, format="f")), ", df = ", .(pet.pes$k - pet.pes$p),
                                              ", p = ", .(formatC(pet.pes$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                              .(formatC(pet.pes$I2, digits=1, format="f")), "%)")))

```

# Meta regressions
```{r}
tbr <- metacont(n.e = hivn,
                   mean.e = m1i,
                   sd.e = sd1i,
                   n.c = controln,
                   mean.c = m2i,
                   sd.c = sd2i,
                   studlab = study,
                   data = pet,
                   sm = "MD",
                   fixed = FALSE,
                   random = TRUE,
                   method.tau = "REML",
                   hakn = TRUE)
```

### Study Quality heterogenetiy assessment
```{r}
# Removal of poor quality studies
pet1 <- pet %>%
  filter(qualityrating== "moderate" | qualityrating == "low")

labs <-pet1$study
labs[2] <- expression("Knudsen 2015*")
labs[4] <- expression("Longenecker 2018*"^a)
labs[5] <- expression("Taglieri 2018*")


pet.pes.q <- rma(yi= diff, sei = se.diff, data = pet1, slab = study)
forest(pet.pes.q,
       addpred=TRUE, header=TRUE,
       xlim= c(-5,0),
       slab = labs,
       addfit = TRUE,
       textpos = c(-5, -.5),
       ilab=cbind(pet1$hivn, pet1$m1i, pet1$controln, pet1$m2i),
       ilab.xpos=c(-3.75, -3.25, -2.5, -2),
       mlab = "",
       digits = 2,
       col = "blue",
       xlab = c("Mean difference in TBR"),)

text(c(-3.75, -3.25, -2.5, -2), 6.5, c("N", "Aortic TBR", "N", "Aortic TBR"))

text(c(-3.5, -2.25), 7.2, c(expression("HIV+"), "HIV -"), font =2)

### add horizontal line at the top
segments(-4, 9.2, -1.6, 9.2)





## add text with Q-value, dfs, p-value, and I^2 statistic
text(-5, -1, pos=4, bquote(paste("RE Model (Q = ",
                                              .(formatC(pet.pes.q$QE, digits=2, format="f")), ", df = ", .(pet.pes.q$k - pet.pes.q$p),
                                              ", p = ", .(formatC(pet.pes.q$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                              .(formatC(pet.pes.q$I2, digits=1, format="f")), "%)")))

```


