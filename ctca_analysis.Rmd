---
title: "Analysis"
output:
  html_document: 
        toc: true
        number_sections: true
        toc_float: true
---
```{r, message=FALSE}
#Load packages
library(tidyverse)
library(readr)
library(metafor)
library(meta)
library(readxl)
library(grid)
library(tidyr)
library(flextable)
```

```{r, warning=FALSE, echo = FALSE}

#Begin Cleaning pipe chain
##########################

#Load excel file
ct <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "all")

#Create database with only studies for CTCA with filter
ct <- ct %>%
  filter(scan== "ctca")

#code cvd as a factor and recode
ct$cvd <- as.factor(ct$cvd)
new.cvd.factor <- c("included", "excluded")
levels(ct$cvd) <- new.cvd.factor

#code BMI as numeric
ct$bmihiv <- as.numeric(ct$bmihiv)
ct$art_time <- as.numeric(ct$art_time)
ct$cd4 <- as.numeric(ct$cd4)
ct$nadircd4 <- as.numeric(ct$nadircd4)

#Exclude Lai et al. & Nadel et al. from analysis as only proportions given and no raw numbers
ct <- ct[-c(7,15),]

#Check Filter and removal of studies
ct %>% select(study, hivn_ct)
```

# CTCA
## Meta-analysis of the prevalence any coronary plaque in PLWH
```{r, warning=FALSE, echo = FALSE, fig.align='center'}

#create dataset with studies that only report any plaque, remove studies that do not have a value for any plaque
ctany <- ct%>% drop_na(anyplaque_n_hiv)

# Meta analysis of prevalence of any plaque on CTCA
# inverse variance, logit transformation of proportions.
any <- metaprop(event = anyplaque_n_hiv, 
                   n = hivn_ct,
                   studlab = study,
                   data = ctany,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   pscale = 100,
                   digits = 1)

forest(any, 
            rightcols=FALSE,
            leftcols=c("studlab", "event", "n", "effect", "ci"),
            leftlabs = c("Study", "Cases", "Total", "Prevalence", "95% C.I."),
            xlim= c(0,110),
            xlab = c("Prevalence of any coronary plaque (%)"),
            smlab = "",
            digits = 1,
            digits.addcols = 1,
       digits.tau2 = 1,
            squaresize = 1,
            weight.study = "fixed",
            sortvar = year,
            fontsize = 10,
            fs.hetstat = 9)
```

## Odds ratio for the prevalence of any coronary plaque in PLWH compared to PWOH
```{r, warning=FALSE, echo=FALSE}

#create dataset with studies that only report any plaque in PLWH & controls
ctanyor <- ct%>% drop_na(anyplaque_n_hiv, anyplaque_n_con)

#random effects meta analysis
# Mantel Haenszel Method

orany <- metabin(event.e = anyplaque_n_hiv,
        n.e = hivn_ct,
        event.c = anyplaque_n_con,
        n.c = controln_ct ,
        data = ctanyor,
        studlab = study,
        method = "MH",
        sm = "OR", 
        incr = 0.5,
        random = TRUE,
        fixed=FALSE)

forest.meta(orany,
            xlim = c(0.1, 5),
            lab.e = c("HIV"),
            lab.c = c("PWOH"),
            leftcols = c("studlab", "effect.ci"),
            leftlabs= c("Study", "OR 95%-CI"),
            rightcols = FALSE,
            smlab = "",
            xlab = c("OR of any coronary plaque"),
            digits = 1,
            print.tau2 = FALSE,
            fontsize = 10,
            fs.hetstat = 9,
            sortvar= year,
            weight.study = "fixed",
            squaresize = 1)
```

## Meta Analysis of prevalence of non calcified coronary plaque in PLWH
```{r, warning=FALSE, echo=FALSE}
#create dataset with studies that only report non calcified plaque plaque
ncct <- ct%>% drop_na(ncplaque_hiv_n)

# Non calcified plaque
# inverse variance, logit transformation of proportions.
noncalc <- metaprop(event = ncplaque_hiv_n, 
                   n = hivn_ct,
                   studlab = study,
                   data = ncct,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   pscale = 100,
                   digits = 1)
forest.meta(noncalc, 
            rightcols=FALSE,
            leftcols=c("studlab", "event", "n", "effect", "ci"),
            leftlabs = c("Study", "Cases", "Total", "Prevalence", "95% C.I."),
            xlim= c(0,110),
            smlab = "",
            xlab = c("Prevalence of non calcified coronary plaque (%)"),
            digits = 1,
            squaresize = 1,
            weight.study = "fixed",
            sortvar = year,
            fontsize = 10,
            fs.hetstat = 9)

```

## Odds of non calcified plaque in PLHIV
```{r}
orncp <- metabin(event.e = ncplaque_hiv_n,
        n.e = hivn_ct,
        event.c = ncplaque_con_n,
        n.c = controln_ct ,
        data = ncct,
        studlab = study,
        method = "MH",
        sm = "OR", 
        incr = 0.5,
        random = TRUE,
        subset = c(1:3, 5:7),
        fixed=FALSE)

forest.meta(orncp,
            xlim = c(0.1, 5),
            lab.e = c("HIV"),
            lab.c = c("PWOH"),
            leftcols = c("studlab", "effect.ci"),
            leftlabs= c("Study", "OR 95%-CI"),
            rightcols = FALSE,
            smlab = "",
            xlab = c("OR of noncalcified plaque"),
            digits = 1,
            print.tau2 = FALSE,
            fontsize = 10,
            fs.hetstat = 9,
            sortvar= year,
            weight.study = "fixed",
            squaresize = 1)
```

## Meta Analysis of calcified coronary plaque in PLWH

```{r, warning=FALSE, echo=FALSE}
#create dataset with studies that only report  calcified plaque 
cct <- ct%>% drop_na(cplaque_hiv_n)

# Calcified plaque
# inverse variance, logit transformation of proportions.

calc <- metaprop(event = cplaque_hiv_n, 
                   n = hivn_ct,
                   studlab = study,
                   data = cct,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   pscale = 100,
                   digits = 1)
forest.meta(calc, 
            rightcols=FALSE,
            leftcols=c("studlab", "event", "n", "effect", "ci"),
            leftlabs = c("Study", "Cases", "Total", "Prevalence", "95% C.I."),
            xlim= c(0,110),
            smlab = "",
            xlab = c("Prevalence of  calcified plaque (%)"),
            digits = 1,
            squaresize = 1,
            weight.study = "fixed",
            sortvar = year,
            fontsize = 10,
            fs.hetstat = 9)
```

## Odds of calcified coronary plaque
```{r}
or_cp <- metabin(event.e = cplaque_hiv_n,
        n.e = hivn_ct,
        event.c = cplaque_con_n,
        n.c = controln_ct ,
        data = cct,
        studlab = study,
        method = "MH",
        sm = "OR", 
        incr = 0.5,
        subset = c(2:3, 5:6),
        random = TRUE,
        fixed=FALSE)

forest.meta(or_cp,
            xlim = c(0.1, 5),
            lab.e = c("HIV"),
            lab.c = c("PWOH"),
            leftcols = c("studlab", "effect.ci"),
            leftlabs= c("Study", "OR 95%-CI"),
            rightcols = FALSE,
            smlab = "",
            xlab = c("OR of calcified plaque"),
            digits = 1,
            print.tau2 = FALSE,
            fontsize = 10,
            fs.hetstat = 9,
            sortvar= year,
            weight.study = "fixed",
            squaresize = 1)
```


## Heterogeneity evaluation of presence of any coronary plaque
### CVD inclusion criteria
Sensitivity analysis excluding two studies that did not exclude patients with cardiovascular disease.
```{r, warning=FALSE, echo=FALSE}
# Presence of any coronary plaque based on whether study excluded patients with CVD
# This has to be a sensitivity analysis as only 2 studies did NOT exclude (Miller 15, Senoner 19)

#Create a subset of studies only EXCLUDING cvd
ctcvd <- subset(ct, cvd=="excluded")
ctcvd <- ctcvd %>% drop_na(anyplaque_n_hiv) 

anycvd <- metaprop(event = anyplaque_n_hiv, 
                   n = hivn_ct,
                   studlab = study,
                   data = ctcvd,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   pscale = 100,
                   digits = 1)
forest(anycvd, 
            rightcols=FALSE,
            leftcols=c("studlab", "event", "n", "effect", "ci"),
            leftlabs = c("Study", "Cases", "Total", "Prevalence", "95% C.I."),
            xlim= c(0,110),
            xlab = c("Prevalence of any coronary plaque (%)"),
            smlab = "",
            digits = 1,
            squaresize = 1,
            weight.study = "fixed",
            sortvar = year,
            fontsize = 10,
            fs.hetstat = 9)
          
```




### Age

Meta regression of any coronary plaque against average age of the study population

```{r, warning=FALSE, echo=FALSE}
# Meta regression of any coronary plaque against average age of the study population
# Mixed effects model meta regression
anyage <- metareg(any, ~ age_hiv,
                       hakn = TRUE,
                       method = "DL",
                       pscale = 100,
                       digits = 2,
                  studlab=any$study,
                  subset= c(1:12)) #remove lo et al. from meta regression

regplot(anyage, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLHIV with any coronary plaque",
        xlab = "Age (years)",
        ci= TRUE,
        label = FALSE,
        pi = FALSE)
```




### Female

Meta regression of any coronary plaque against the proportion of women in the study population

```{r, warning=FALSE, echo=FALSE}
# Mixed effects model meta regression
anyfemale <- metareg(any, ~ femalehivprop,
                       hakn = TRUE,
                       method = "DL",
                       pscale = 100,
                       digits = 2,
                     subset= c(1:12)) #remove lo et al. from meta regression)

regplot(anyfemale, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLHIV with any coronary plaque",
        xlab = "Proportion of women in study population (%)",
        ci= TRUE,
        pi = FALSE)
```




### Smokers

Meta regression of any coronary plaque against the proportion of smokers in the study population

```{r, warning=FALSE, echo=FALSE}
# Meta regression of the proportion of smokers in the study population
# Not reported by: DETTORE
anysmoke <- metareg(any, ~ smokehivprop,
                       hakn = TRUE,
                       method = "DL",
                       pscale = 100,
                       digits = 2,
                    subset= c(1:12)) #remove lo et al. from meta regression)

regplot(anysmoke, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLHIV with any coronary plaque",
        xlab = "Proportion of smokers in study population (%)",
        ci= TRUE,
        pi = FALSE)
```



### BMI

Meta regression of any coronary plaque against the mean BMI of the study population

```{r,warning=FALSE, echo=FALSE}
# Meta regression of BMI of study population against any coronary plaque

anybmi <- metareg(any, ~ bmihiv,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2,
                  subset= c(1:12)) #remove lo et al. from meta regression)

regplot(anybmi, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLHIV with any coronary plaque",
        xlab = "Mean BMI in study population (kg/m2)",
        ci= TRUE,
        pi = FALSE)
```




### Anti-retroviral therapy

Meta regression of any coronary plaque against the proportion of PLWH on ART in the study population

```{r, warning=FALSE, echo=FALSE}
# Meta regression of Proportion of study population on ART 

anyart <- metareg(any, ~ artprop,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2,
                  subset= c(1:12)) #remove lo et al. from meta regression)

regplot(anyart, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLHIV with any coronary plaque",
        xlab = "Proportion of PWH on ART",
        ci= TRUE,
        pi = FALSE)
```




### Time on ART

Meta regression of any coronary plaque against the mean time on ART in the study population

```{r, warning=FALSE, echo=FALSE}
# Meta regression of coronary plaque by the mean time in years on ART in study population
# Not reportedby Hoffman, DABRAMO, Kapelios 2021

anytime <- metareg(any, ~ art_time,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2,
                   subset= c(1:12)) #remove lo et al. from meta regression)

regplot(anytime, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLHIV with any coronary plaque",
        xlab = "Mean duration on ART (years)",
        ci= TRUE,
        pi = FALSE)

```




### CD4 count

Meta regression of any coronary plaque against the mean CD4 count in the study population

```{r, warning=FALSE, echo=FALSE}
# Meta regression of coronary plaque by the mean CD4 in study population
# Not reported by Hoffman

anycd4 <- metareg(any, ~ cd4,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2,
                        subset= c(1:12)) #remove lo et al. from meta regression)

regplot(anycd4, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLHIV with any coronary plaque",
        xlab = "Mean CD4 count (cells/microl)",
        ci= TRUE,
        pi = FALSE)
```




### Nadir CD4 count

Meta regression of any coronary plaque against the mean nadir CD4 count in the study population

```{r, warning=FALSE, echo=FALSE}
# Meta regression of coronary plaque by mean nadir CD4 in study population
# Not reported by Hoffman, Jeudy

anynadir <- metareg(any, ~ nadircd4,
                       hakn = TRUE,
                       method = "DL",
                       digits = 2,
                    subset= c(1:12)) #remove lo et al. from meta regression)

regplot(anynadir, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLHIV with any coronary plaque",
        xlab = "Nadir CD4 count (cells/microl)",
        ci= TRUE,
        pi = FALSE)
```




### Summary of MetaRegressions
```{r, echo=FALSE, warning=FALSE}
regresult <- tibble(
    Variable = c("Age", "Proportion female", "Proportion smokers", "Mean BMI", "Proportion on ART", "Time on ART", "Mean CD4", "Nadir CD4"),
    no.studies = c(anyage$k, anyfemale$k, anysmoke$k, anybmi$k, anyart$k, anytime$k, anycd4$k, anynadir$k),
    regression.coefficent = c(anyage$b[[2]], anyfemale$b[[2]], anysmoke$b[[2]], anybmi$b[[2]], anyart$b[[2]], anytime$b[[2]], anycd4$b[[2]], anynadir$b[[2]]),
    ci.lower = c(anyage$ci.lb[[2]], anyfemale$ci.lb[[2]], anysmoke$ci.lb[[2]], anybmi$ci.lb[[2]], anyart$ci.lb[[2]], anytime$ci.lb[[2]], anycd4$ci.lb[[2]], anynadir$ci.lb[[2]]),
    ci.upper = c(anyage$ci.ub[[2]], anyfemale$ci.ub[[2]], anysmoke$ci.ub[[2]], anybmi$ci.ub[[2]], anyart$ci.ub[[2]], anytime$ci.ub[[2]], anycd4$ci.ub[[2]], anynadir$ci.ub[[2]]),
    p.value = c(anyage$pval[[2]], anyfemale$pval[[2]], anysmoke$pval[[2]], anybmi$pval[[2]], anyart$pval[[2]], anytime$pval[[2]], anycd4$pval[[2]], anynadir$pval[[2]]),
    R2 = c(anyage$R2, anyfemale$R2, anysmoke$R2, anybmi$R2, anyart$R2, anytime$R2, anycd4$R2, anynadir$R2),
      )%>%
  mutate(across(where(is.numeric), round, digits = 2))
regresult <- regresult %>% flextable() %>%
  theme_vanilla()%>%
  set_header_labels(
    variable = "Variable",
    no.studies = "N studies",
    regression.coefficent = "Regression Coefficent",
    ci.lower = "95% CI lower",
    ci.upper = "95% CI upper",
    p.value = "P Value",
    R2 = "R Squared")
regresult
```

## Exploration of heterogeneity by study design
### Sensitivity analysis with studies of poor quality excluded
```{r}
#Updated meta estiamte with Frustaci removed and Breukman
#Create dataframe with poor quality studies removed
ctqual <-  ctany %>% 
  filter(quality != "poor")   

qual <- metaprop(event = anyplaque_n_hiv, 
                   n = hivn_ct,
                   studlab = study,
                   data = ctqual,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   pscale = 100,
                   digits = 1)
forest(qual, 
            rightcols=FALSE,
            leftcols=c("studlab", "event", "n", "effect", "ci"),
            leftlabs = c("Study", "Cases", "Total", "Prevalence", "95% C.I."),
            xlim= c(0,110),
            smlab = c("Prevalence of any coronary plaque (%)"),
            digits = 1,
            squaresize = 1,
            weight.study = "fixed",
            sortvar = year,
            fontsize = 10,
            fs.hetstat = 9)
```



## Meta-Analysis of prevalence of a coronary stenosis >50% 

Meta analysis demonstrating the prevalence of a coronary stenosis>50% in PLWH

```{r, warning=FALSE, echo=FALSE}
# Select data that reports 50% stenosis in PLWH
ct50 <- ct%>% drop_na(stenhiv50n)

stenosis50 <- metaprop(event = stenhiv50n, 
                   n = hivn_ct,
                   studlab = study,
                   data = ct50,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   digits = 1,
                   pscale = 100)

forest.meta(stenosis50, 
            rightcols=FALSE,
            leftcols=c("studlab", "event", "n", "effect", "ci"),
            leftlabs = c("Study", "Cases", "Total", "Prevalence", "95% C.I."),
            xlim= c(0,110),
            smlab = "",
            xmlab = c("Prevalence of >50% stenosis (%)"),
            digits = 1,
            squaresize = 1,
            weight.study = "fixed",
            sortvar = year,
            fontsize = 10,
            fs.hetstat = 9,
            digits.tau2 = 2)
```

## Meta-Analysis of the odss of PLWH having a >50% stenosis comapred to PWOH

```{r, warning=FALSE, echo=FALSE}

#create dataset with studies that only report 50% stenosis in PWH and PWOH
ct50or <- ct%>% drop_na(stenhiv50n, stencon50n)

#random effects meta analysis
# Mantel Haenszel Method

ct50or1 <- metabin(event.e = stenhiv50n,
        n.e = hivn_ct,
        event.c = stencon50n,
        n.c = controln_ct ,
        data = ct50or,
        studlab = study,
        method = "MH",
        sm = "OR", 
        incr = 0.5,
        random = TRUE,
        subset=c(2:10)
,        fixed=FALSE)

forest.meta(ct50or1,
            lab.e = c("HIV"),
            lab.c = c("PWOH"),
            leftcols = c("studlab", "effect.ci"),
            leftlabs= c("Study", "OR 95%-CI"),
            rightcols = FALSE,
            smlab = "",
            xlab = c("Odds ratio of a >50% coronary stenosis"),
            fontsize = 10,
            digits = 1,
            sortvar= year,
            weight.study = "fixed",
            squaresize = 1)
```



### Subgroup analysis of 50% stenosis by CVD exclusion or inclusion

```{r, warning= FALSE, echo=FALSE}
stenosis50cvd <-update.meta(stenosis50,
                subgroup = excludedcad)

forest.meta(stenosis50cvd,
            rightcols=FALSE,
            leftcols=c("studlab", "event", "n", "effect", "ci"),
            leftlabs = c("Study", "Cases", "Total", "Prevalence", "95% C.I."),
            xlim= c(0,110),
            smlab = c("Prevalence of >50% stenosis (%)"),
            digits = 1,
            squaresize = 1,
            weight.study = "fixed",
            sortvar = year,
            fontsize = 10,
            fs.hetstat = 9,
            digits.tau2 = 2)
```




## Meta analysis of 70% stenosis

Meta analysis demonstrating the prevalence of a coronary stenosis>70% in PLWH

```{r, warning=FALSE, echo=FALSE}
# Select data that reports 50% stenosis in PLWH
ct70 <- ct%>% drop_na(stenhiv70n)
stenosis70 <- metaprop(event = stenhiv70n, 
                   n = hivn_ct,
                   studlab = study,
                   data = ct70,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   digits = 1,
                   pscale = 100)

forest.meta(stenosis70,
            rightcols=FALSE,
            leftcols=c("studlab", "event", "n", "effect", "ci"),
            leftlabs = c("Study", "Cases", "Total", "Prevalence", "95% C.I."),
            xlim= c(0,20),
            smlab = c("Prevalence of >70% stenosis (%)"),
            digits = 1,
            squaresize = 1,
            weight.study = "fixed",
            sortvar = year,
            fontsize = 10,
            fs.hetstat = 9,
            digits.tau2 = 2)

```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
```

```{r, message=FALSE}
#Load packages
library(tidyverse)
library(readr)
library(metafor)
library(meta)
library(readxl)
library(grid)
library(tidyr)
library(flextable)
library(rmarkdown)

```


```{r}

#Begin Cleaning pipe chain
##########################

#Load excel file
mri <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "mri")

#code cvd as a factor
mri$cvd <- as.factor(mri$cvd)
new.cvd.factor <- c("included", "excluded")
levels(mri$cvd) <- new.cvd.factor


#Create subset of data that contains LGE in HIV only
mrilge <- mri%>% drop_na(lgehivn)
```


# MRI
## Meta-Analysis of prevalence of LGE in people with HIV 

```{r, echo = FALSE}
# Meta analysis of proportions
# Inverse variance meta analysis
# Random effects meta-analysis
# Exclude Zanni 20, Lai 09, pnieura  as no prevalence of LGE given
# study labels used.


lge <-  metaprop(event = mrilge$lgehivn, 
                   n = mrilge$hivnmri,
                   studlab = paper,
                   data = mrilge,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   title = "LGE prevalence",
                   pscale = 100,
                   digits = 1)
forest <- forest.meta(lge, 
            rightcols=FALSE,
            leftcols=c("studlab", "event", "n", "effect", "ci"),
            leftlabs = c("Study", "Cases", "Total", "Prevalence", "95% C.I."),
            xlim= c(0,110),
            smlab = c("Prevalence of LGE (%)"),
            digits = 1,
            squaresize = 1,
            weight.study = "fixed",
            sortvar = pubyear,
            fontsize = 10,
            fs.hetstat = 9)
```



```{r}
#Alternative using metafor package for meta regressions 
ies <- escalc(xi=lgehivn, ni=hivnmri, data=mri, measure="PR")
pooled.logit <- rma(yi, vi, data=ies, method= "DL")
pooled <- predict(pooled.logit, transf=transf.ilogit)
precision<-sqrt(pooled.logit$vi)
pooled.logit
```



```{r}
#Alternative Methods for Pooling Proportions
# Random intercept logistic regression model
# Maximum-likelihood estimator for tau^2
# Logit transformation


lge.glmm <-  update(lge, sm = "PLOGIT", method= "GLMM")

```

```{r}
#Inverse variance method
# Freeman-Tukey double arcsine transformation
lge.prop.pft <- update(lge, sm = "PFT", method= "Inverse")
```









## Heterogeneity of prevalance of myocardial fibrosis

### Subgroup analysis- CVD exclusion

Subgroup by whether studies excluded patients with CV disease

```{r}
#Subgroup by whether studies excluded patients with CV disease 

lgecvd <-update.meta(lge,
                subgroup = cvd,
                subgroup.name = c("CVD"),
                tau.common = FALSE)

forest.meta(lgecvd,
           ref = 0,
           fontsize = 10,
           xlim = c(0, 100),
           print.subgroup.labels = TRUE,
           rightcols = FALSE,
           leftcols=c("studlab", "event", "n", "effect", "ci"),
           leftlabs = c("Study", "Cases", "Total", "Prevalence(%)", "95% C.I."),
           rightlabs = c("Prop LGE", "95%-CI", "Weight"),
           smlab = c("Prevalence of LGE (%)"),
           just.studlab = "right",
           addrow = FALSE,
           addrow.overall = FALSE,
           addrow.subgroups = FALSE,
           colgap = "0.1cm",
           overall = FALSE,
           test.overall = FALSE,
           weight.study = "fixed",
           digits = 1,
           squaresize = 1,
           fs.hetstat = 9,
           sortvar = pubyear,
           print.tau2 = FALSE,
           print.Q = FALSE,
           print.Q.subgroup = TRUE)
```

### Subgroup analysis by income stauts of country

```{r}
lge.prop.income <-update.meta(lge,
                subgroup = income,
                tau.common = FALSE)
forest.meta(lge.prop.income,
           ref = 0,
           fontsize = 10,
           xlim = c(0, 100),
           print.subgroup.labels = TRUE,
           rightcols = FALSE,
           leftcols=c("studlab", "event", "n", "effect", "ci"),
           leftlabs = c("Study", "Cases", "Total", "Prevalence(%)", "95% C.I."),
           rightlabs = c("Prop LGE", "95%-CI", "Weight"),
           smlab = c("Prevalence of LGE (%)"),
           just.studlab = "right",
           addrow = FALSE,
           addrow.overall = FALSE,
           addrow.subgroups = FALSE,
           colgap = "0.1cm",
           overall = FALSE,
           test.overall = FALSE,
           weight.study = "fixed",
           digits = 1,
           squaresize = 1,
           print.tau2 = FALSE)

```


### Anti-retroviral treatment


A sensitivity analysis restricting the meta estimate to only studies that recruited patients on stable ART, as defined by the study.


```{r}
#Meta-analysis of studies that exclusively enrolled particpants that are on stable ART
#Exclude:Wu 21, Ntusi, Thiara, Menacho, de leuw, chew, yan, scholtz
#Exclude: 1, 5, 8, 12, 13,  14

# Create dataset with ART treated patients only
mriart <- subset(mrilge, stableart=="yes")

lgeart <-  metaprop(event = mriart$lge_art_n, 
                   n = mriart$mri_art_n,
                   studlab = paper,
                   data = mriart,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   fixed = FALSE,
                   random = TRUE, #random effects meta analysis
                   title = "LGE prevalence",
                   pscale = 100,
                   digits = 1)
forest.meta(lgeart,
            rightcols=FALSE,
            leftcols=c("studlab", "event", "n", "effect", "ci"),
            leftlabs = c("Study", "Cases", "Total", "Prevalence", "95% C.I."),
            xlim= c(0,110),
            smlab = c("Prevalence of LGE (%)"),
            digits = 1,
            squaresize = 1,
            weight.study = "fixed",
            fontsize = 10,
            fs.hetstat = 9)
```


### Meta regression by mean age of study population
```{r}
# Mixed effects model meta regression
lgeage <- metareg(lge, ~ agehiv,
                       hakn = TRUE,
                       method = "DL",
                       pscale = 100,
                       digits = 2)

regplot(lgeage, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLWH with LGE",
        xlab = "Age (years)",
        ci= FALSE,
        pi = FALSE)
```

### Meta regression by CD4 of study population 

```{r}
#For mean CD4, Ntusi et al. do not present a CD4 count, the same cohort is included in Holloway et al.
#Therefore the meta analysis of prevalence will be repeated with Holloway instead of Ntusi

#Meta analysis of prevalence of LGE (Hollloway replacing NTUSI)

mricd4 <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "mricd4") #read in new excel with holloway

#Create subset of data that contains LGE in HIV only
mricd4 <- mricd4 %>% drop_na(lgehivn)

cd4 <- metaprop(event = mricd4$lgehivn, 
                   n = mricd4$hivnmri,
                   studlab = paper,
                   data = mricd4,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   title = "LGE prevalence",
                   pscale = 100,
                   digits = 1)


# Mixed effects model meta regression
lgecd4.2 <- metareg(cd4, ~ cd4mean,
                       hakn = TRUE,
                       method = "DL",
                       pscale = 100,
                       digits = 2)

regplot(lgecd4.2, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLWH with LGE",
        xlab = "Average CD4 count (cells/microL)",
        ci= FALSE,
        pi = FALSE)
```


```{r}
#This is the old code for the CD4 meta regression with NTUSI instead of Holloway
# Mixed effects model meta regression
lgecd4 <- metareg(lge, ~ cd4mean,
                       hakn = TRUE,
                       method = "DL",
                       pscale = 100,
                       digits = 2)
regplot(lgecd4, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLWH with LGE",
        xlab = "Average CD4 count (cells/microL)",
        ci= FALSE,
        pi = FALSE)
lgecd4
```

### Meta regression by proportion of smokers
```{r}
# Mixed effects model meta regression
lgesmoke <- metareg(lge, ~ smoke_hiv_prop,
                       hakn = TRUE,
                       method = "DL",
                       pscale = 100,
                       digits = 2)
regplot(lgesmoke, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLWH with LGE",
        xlab = "Proportion of smokers in study population(%)",
        ci= FALSE,
        pi = FALSE)
```

### Meta regression duration of HIV

```{r}



# Mixed effects model meta regression
lgetime <- metareg(lge, ~ hivtime,
                       hakn = TRUE,
                       method = "DL",
                       pscale = 100,
                       digits = 2)
regplot(lgetime, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLWH with LGE",
        xlab = "Duration of HIV diagnosis (y)",
        ci= FALSE,
        pi = FALSE)
```

```{r}
#Create a 4 panel plot of meta regressions
layout(matrix(1:4, ncol=2, byrow=TRUE))
regplot(lgetime, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLWH with LGE",
        xlab = "Duration of HIV diagnosis (y)",
        ci= FALSE,
        pi = FALSE)
regplot(lgesmoke, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLWH with LGE",
        xlab = "Proportion of smokers in study population(%)",
        ci= FALSE,
        pi = FALSE)
regplot(lgecd4.2, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLWH with LGE",
        xlab = "Average CD4 count (cells/microL)",
        ci= FALSE,
        pi = FALSE)
regplot(lgeage, 
        transf=transf.ilogit, 
        ylim = c(0,1),
        ylab = "Proportion of PLWH with LGE",
        xlab = "Age (years)",
        ci= FALSE,
        pi = FALSE)
```


### Summary of Meta-Regressions

```{r, echo=FALSE}
mrireg <- tibble(
    variable = c("Age", "CD4 Count", "Proportion of Smokers", "Time of HIV diagnosis"),
    no.studies = c(lgeage$k, lgecd4.2$k, lgesmoke$k, lgetime$k),
    regression.coefficent = c(lgeage$b[[2]], lgecd4.2$b[[2]], lgesmoke$b[[2]], lgetime$b[[2]]),
    ci.lower = c(lgeage$ci.lb[[2]], lgecd4.2$ci.lb[[2]], lgesmoke$ci.lb[[2]],lgetime$ci.lb[[2]]),
    ci.upper = c(lgeage$ci.ub[[2]], lgecd4.2$ci.ub[[2]], lgesmoke$ci.ub[[2]], lgetime$ci.ub[[2]]),
    p.value = c(lgeage$pval[[2]], lgecd4.2$pval[[2]], lgesmoke$pval[[2]], lgetime$pval[[2]]),
    R2 = c(lgeage$R2, lgecd4.2$R2, lgesmoke$R2, lgetime$R2)) %>%
  mutate(across(where(is.numeric), round, digits = 2))
mrireg <- flextable(mrireg) %>%
  theme_vanilla()%>%
  set_header_labels(
    variable = "Variable",
    no.studies = "N studies",
    regression.coefficent = "Regression Coefficent",
    ci.lower = "95% CI lower",
    ci.upper = "95% CI upper",
    p.value = "P Value",
    R2 = "R Squared")%>%
  autofit()
mrireg
```


## Differences in study design
### Sensitivity analysis- removal of studies with selection bias
```{r}
#Updated meta estiamte with Frustaci removed and Breukman
#Create dataframe with Frustaci and Breukman removed
mriselect <- mrilge[-c(9,10),]

lgeselect <- metaprop(event = lgehivn, 
                   n = hivnmri,
                   studlab = paper,
                   data = mriselect,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   title = "LGE prevalence",
                   pscale = 100,
                   digits = 1)
forest(lgeselect, 
            rightcols=FALSE,
            leftcols=c("studlab", "event", "n", "effect", "ci"),
            leftlabs = c("Study", "Cases", "Total", "Prevalence", "95% C.I."),
            xlim= c(0,110),
            smlab = "",
            xlab = c("Prevalence of LGE (%)"),
            digits = 1,
            squaresize = 1,
            weight.study = "fixed",
            sortvar = pubyear,
            fontsize = 10,
            fs.hetstat = 9)
```

### Sensitivity analysis- removal of low quality studies
```{r}
#Updated meta estiamte with Frustaci removed and Breukman
#Create dataframe with Frustaci and Breukman removed
mriquality <- mriquality <- mrilge %>% 
  filter(quality != "poor")   

lgequality <- metaprop(event = lgehivn, 
                   n = hivnmri,
                   studlab = paper,
                   data = mriquality,
                   method = "Inverse",#Inverse variance method
                   sm = "PLOGIT", #Log transformation of proportions
                   random = TRUE,#random effects meta analysis
                   fixed = FALSE,
                   title = "LGE prevalence",
                   pscale = 100,
                   digits = 1)
forest(lgequality, 
            rightcols=FALSE,
            leftcols=c("studlab", "event", "n", "effect", "ci"),
            leftlabs = c("Study", "Cases", "Total", "Prevalence", "95% C.I."),
            xlim= c(0,110),
            xlab = c("Prevalence of LGE (%)"),
            digits = 1,
            squaresize = 1,
            weight.study = "fixed",
            sortvar = pubyear,
            fontsize = 10,
            fs.hetstat = 9)
```


# Meta-Analysis of crude odds ratio for LGE

```{r}
# Meta analysis of crude odds ratio LGE
# Mantel-Haenszel method
# Restricted maximum-likelihood estimator for tau^2
# Q-profile method for confidence interval of tau^2 and tau
# Continuity correction of 0.5 in studies with zero cell frequencies

mrior <- mrilge %>% drop_na(lgecontroln)

orlge <- metabin(event.e = lgehivn,
        n.e = hivnmri,
        event.c = lgecontroln,
        n.c = controlnmri,
        data = mrior,
        studlab = paper,
        method = "MH",
        sm = "OR", 
        incr = 0.5,
        random = TRUE,
        fixed=FALSE)


forest.meta(orlge,
            xlim =c(0.1,40),
            smlab = c(""),
            leftcols = c("studlab", "effect.ci"),
            leftlabs= c("Study", "Unadjusted Odds Ratio 95%-CI"),
            fontsize = 10,
            digits =1,
            rightcols=FALSE,
            sortvar=pubyear)


```

# ECV fraction meta-analysis 

```{r}
# load ecv data 
ecv <- read_excel("hiv_sr_databse.xlsx",     
                             sheet = "ecv")
#Pooled mean ECV
# Inverse variance, raw means pooled, random effects. 
ecvmean <-metamean(n = hivnmri,
                  mean = ecvfrachiv,
                  sd = ecvfrachiv_sd,
                  data = ecv,
                  studlab = paper,
                  digits = 1,
                  random = TRUE,
                  fixed = FALSE)
```

```{r}
#mean difference in ECV
ecvsmd <- metacont(n.e = hivnmri,
                     mean.e = ecvfrachiv,
                     sd.e = ecvfrachiv_sd,
                     n.c = controlnmri,
                     mean.c = ecvfraccontrol,
                     sd.c = ecvfracctonrol_sd,
                     data = ecv,
                   subset = c(1:6, 8),
                     sm = "MD",
                     fixed = FALSE,
                     random = TRUE,
                     studlab = paper)
forest.meta(ecvsmd,
            digits = 1,
            xlim = c(-1, 5),
            digits.stat = 2,
            digits.tau2 = 2,
            smlab = c(""),
            leftcols=c("studlab", "mean.e", "mean.c","effect.ci"),
            leftlabs = c("Study", "ECV PLHIV", "ECV Controls", "MD[95%-CI]"),
            fontsize = 10,
            rightcols = FALSE,
            weight.study = "random",
            xlab = "Difference in ECV fraction (%)")

          
```

# T1 time  meta-analysis 
```{r echo=FALSE}
#mean difference in t1
#Details on meta-analytical method:
#Inverse variance method
#Restricted maximum-likelihood estimator for tau^2
#Q-profile method for confidence interval of tau^2 and tau
# Hedges' g (bias corrected standardised mean difference; using exact formulae)

#Dataset for T1
mrit1 <- mrilge %>% drop_na(t1_mean_hiv)

t1smd <- metacont(n.e = hivnmri,
                     mean.e = t1_mean_hiv,
                     sd.e = t1_hiv_sd,
                     n.c = controlnmri,
                     mean.c = t1_control_mean,
                     sd.c = t1_control_sd,
                     data = mrit1,
                     sm = "MD",
                     fixed = FALSE,
                     random = TRUE,
                     studlab = paper)

forest(t1smd,
       xlim = c(-10, 100),
            digits = 1,
            digits.sd = 1, 
            digits.mean = 1,
            digits.stat = 1,
            digits.tau2 = 1,
            leftcols=c("studlab", "mean.e", "mean.c","effect.ci"),
            leftlabs = c("Study", "T1 PLWH", "T1 PWOH", "MD[95%-CI]"),
            fontsize = 10,
            xlab = "Native T1 time (msec)",
            rightcols = FALSE,
            weight.study = "random")

```
#Funnell Plots MRI

```{r}
funnel.meta(lge,
            studlab = FALSE,
            pos.studlab = 4,
            font = 8)

metabias(lge, method.bias = "linreg", k.min = 9, box = FALSE)

```


```{r}
#create a dataframe with relevent results for meta-analysis
tibte <- transf.ilogit(lge$TE)*100
tibpool <- transf.ilogit(lge$TE.random)*100
#tranform lower and upper ci of te
tiblower <- transf.ilogit(lge$lower.random)*100
tiupper <- transf.ilogit(lge$upper.random)*100

#create tibble 
tib <- tibble(
    study = c(lge$studlab, "Random Effects Model"),
    te = c(tibte, tibpool),
    cilow = c((lge$lower*100), tiblower),
    ciup = c(lge$upper*100, tiupper),
    cat = c("study", "study", "study", "study", "study", "study", "study", "study", "study", "study", "study", "study", "study", "study","study", "re"))
tib
p <- ggplot(tib, aes(y = study, x= te, xmin=cilow, xmax= ciup))+
  geom_point()+
  geom_errorbarh(height=.1)+
  geom_point(data= subset(tib, cat= "re"), shape= 18, size= 4)
p

```

